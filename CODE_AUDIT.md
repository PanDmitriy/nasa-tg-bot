# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ nasa-tg-bot

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 1.0.0  
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Feature-Sliced Design (FSD)  
**–°—Ç–µ–∫:** TypeScript, Node.js, Telegraf, Prisma, Axios, Docker

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã](#—Å–∏–ª—å–Ω—ã–µ-—Å—Ç–æ—Ä–æ–Ω—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
3. [–ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞](#–ø—Ä–æ–±–ª–µ–º—ã-–∫–∞—á–µ—Å—Ç–≤–∞-–∫–æ–¥–∞)
4. [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
5. [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
6. [–ü—Ä–æ–±–ª–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#–ø—Ä–æ–±–ª–µ–º—ã-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
7. [–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#–ø—Ä–æ–±–ª–µ–º—ã-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
8. [–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–ø—Ä–æ–±–ª–µ–º—ã-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
9. [Roadmap —É–ª—É—á—à–µ–Ω–∏–π](#roadmap-—É–ª—É—á—à–µ–Ω–∏–π)

---

## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ **FSD —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** ‚Äî –ø—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Feature-Sliced Design —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ–µ–≤
- ‚úÖ **Dependency Injection** ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–æ—Å—Ç–æ–π DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- ‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ —Å–µ—Ä–≤–∏—Å—ã, —Ö–µ–Ω–¥–ª–µ—Ä—ã —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—Ç
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –µ–¥–∏–Ω—ã–π middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Sentry
- ‚úÖ **Rate Limiting** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ –∏ callback queries

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- ‚úÖ **TypeScript strict mode** ‚Äî –≤–∫–ª—é—á–µ–Ω strict —Ä–µ–∂–∏–º —Å —Ö–æ—Ä–æ—à–µ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ **Retry –º–µ—Ö–∞–Ω–∏–∑–º** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API —Å exponential backoff
- ‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π (TTL 24 —á–∞—Å–∞)
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Äî `/start`, `/apod`, `/earth`, `/asteroids`, `/images`, `/donki`, `/help` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- ‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∏** ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **Prisma –º–∏–≥—Ä–∞—Ü–∏–∏** ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã –ë–î** ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ schema

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ

#### 1. –ù–∞—Ä—É—à–µ–Ω–∏–µ FSD: features –∑–∞–≤–∏—Å—è—Ç –æ—Ç processes
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ (`commands.subscribe.ts`, `commands.unsubscribe.ts`) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `features/subscriptions/`, –Ω–æ –æ–Ω–∏ –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç `BotContext` –∏–∑ `processes/bot/types.ts`. –≠—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ FSD –æ —Ç–æ–º, —á—Ç–æ features –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç processes.

**–§–∞–π–ª—ã:**
- `src/features/subscriptions/commands.subscribe.ts`
- `src/features/subscriptions/commands.unsubscribe.ts`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –°–æ–∑–¥–∞—Ç—å shared/types/telegram.ts —Å –±–∞–∑–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏
export interface BaseTelegramContext {
  from?: { id: number; username?: string };
  chat?: { id: number };
  reply: (text: string, options?: any) => Promise<any>;
  // ... –¥—Ä—É–≥–∏–µ –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
}

// –í features –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BaseTelegramContext –≤–º–µ—Å—Ç–æ BotContext
```

#### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–ª–∏–µ–Ω—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—É—â–µ—Å—Ç–≤—É—é—Ç –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö NASA API –∫–ª–∏–µ–Ω—Ç–∞:
- `src/shared/api/nasa.ts` (NasaApi) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ features
- `src/features/nasa/api.ts` (NasaAPI) ‚Äî —Å—Ç–∞—Ä—ã–π, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –Ω–µ —É–¥–∞–ª–µ–Ω

**–§–∞–π–ª—ã:**
- `src/shared/api/nasa.ts`
- `src/features/nasa/api.ts`

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å `src/features/nasa/api.ts` –∏ –≤—Å–µ –µ–≥–æ –∏–º–ø–æ—Ä—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å).

#### 3. DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ–ø–æ–ª–Ω—ã–π
**–ü—Ä–æ–±–ª–µ–º–∞:** DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:
- `SubscriptionService` —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ scheduler
- `DonkiApi`, `EarthApi`, `ImagesApi` –Ω–µ –∏–º–µ—é—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è
- –ù–µ—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–§–∞–π–ª—ã:**
- `src/shared/di/container.ts`
- `src/processes/schedulers/subscription.scheduler.ts`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –†–∞—Å—à–∏—Ä–∏—Ç—å DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
class DIContainer {
  private _subscriptionService: SubscriptionService | null = null;
  
  get subscriptionService(): SubscriptionService {
    if (!this._subscriptionService) {
      this._subscriptionService = new SubscriptionService();
    }
    return this._subscriptionService;
  }
  
  // –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
}
```

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ª–æ—è repositories –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ `DonkiSubscription` –∏–º–µ–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –Ω–æ `Subscription`, `User`, `Premium` —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é —Å Prisma.

**–§–∞–π–ª—ã:**
- `src/shared/db/repositories/subscriptions.ts` (—Ç–æ–ª—å–∫–æ –¥–ª—è DonkiSubscription)
- `src/features/subscriptions/subscription.service.ts` (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ Prisma)

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:
- `UserRepository`
- `SubscriptionRepository` (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫)
- `PremiumRepository`

#### 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ zod/envsafe
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—Ä—É—á–Ω—É—é –≤ `src/app/index.ts`, –Ω–µ—Ç —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ zod.

**–§–∞–π–ª—ã:**
- `src/app/index.ts` (—Ñ—É–Ω–∫—Ü–∏—è `validateConfig`)
- `src/app/config/development.ts`
- `src/app/config/production.ts`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/app/config/validation.ts
import { z } from 'zod';

const envSchema = z.object({
  TELEGRAM_BOT_TOKEN: z.string().min(1),
  NASA_API_KEY: z.string().min(1),
  DATABASE_URL: z.string().default('file:./data/bot.db'),
  NODE_ENV: z.enum(['development', 'production']).default('development'),
  SENTRY_DSN: z.string().optional(),
  STRIPE_SECRET_KEY: z.string().optional(),
  // ...
});

export const env = envSchema.parse(process.env);
```

---

## üíª –ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ

#### 6. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞–π–¥–µ–Ω–æ 17 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `any`, –æ—Å–æ–±–µ–Ω–Ω–æ –≤:
- `src/processes/schedulers/subscription.scheduler.ts` (params: any, payload: any)
- `src/features/subscriptions/subscription.service.ts` (params?: Record<string, any>)
- `src/features/subscriptions/commands.unsubscribe.ts` (buttons: any[])

**–§–∞–π–ª—ã:**
- `src/processes/schedulers/subscription.scheduler.ts:92, 96, 168, 194, 260`
- `src/features/subscriptions/subscription.service.ts:10`
- `src/features/subscriptions/commands.unsubscribe.ts:46`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã –¥–ª—è params –ø–æ–¥–ø–∏—Å–æ–∫
export interface SubscriptionParams {
  type?: 'natural' | 'enhanced'; // –¥–ª—è earth
  eventType?: 'cme' | 'notifications' | 'wsaenlil'; // –¥–ª—è donki
}

// –í scheduler
private async sendSubscriptionNotification(subscription: {
  id: number;
  telegramId: string;
  chatId: string;
  type: string;
  params: SubscriptionParams | null;
}) { ... }
```

#### 7. –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–º–∏—Å—ã –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –ø—Ä–æ–º–∏—Å—ã –Ω–µ –æ–∂–∏–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `await`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ "–∑–∞–≤–∏—Å—à–∏–º –ø—Ä–æ–º–∏—Å–∞–º".

**–§–∞–π–ª—ã:**
- `src/processes/notifications/donki-notifications.ts:46, 52` ‚Äî `.catch()` –±–µ–∑ await
- `src/processes/bot/index.ts:189-218` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ action –º–æ–≥—É—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –í donki-notifications.ts
this.checkNewEvents().catch((error) => {
  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–±—ã—Ç–∏–π:', error);
  Sentry.captureException(error);
});

// –í bot/index.ts - –æ–±–µ—Ä–Ω—É—Ç—å –≤—Å–µ action handlers
this.bot.action(/^donki_cme_(today|week|month|7days)$/, async (ctx) => {
  try {
    if ('data' in ctx.callbackQuery) {
      const period = ctx.callbackQuery.data.split('_').pop();
      const days = period === 'today' ? 1 : period === 'week' ? 7 : period === 'month' ? 30 : 7;
      await handleDonkiCMEData(ctx as BotContext, days);
    }
  } catch (error) {
    await handleTelegramError(ctx as BotContext, error, 'DonkiCME');
  }
});
```

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 8. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤ –≤ DONKI handlers:
- `src/processes/bot/index.ts:189-219` ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–∏–æ–¥–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ —É—Ç–∏–ª–∏—Ç—É:
```typescript
// src/shared/lib/dateHelpers.ts
export function parsePeriodToDays(period: string): number {
  const periodMap: Record<string, number> = {
    today: 1,
    week: 7,
    month: 30,
    '7days': 7,
  };
  return periodMap[period] || 7;
}
```

#### 9. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è Prisma Json –ø–æ–ª–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** `params: Json?` –≤ Prisma schema –Ω–µ –∏–º–µ–µ—Ç TypeScript —Ç–∏–ø–æ–≤.

**–§–∞–π–ª—ã:**
- `prisma/schema.prisma:45`
- `src/features/subscriptions/subscription.service.ts:10`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/entities/subscription/types.ts
export interface SubscriptionParams {
  type?: 'natural' | 'enhanced';
  eventType?: 'cme' | 'notifications' | 'wsaenlil';
  alertLevel?: 'extreme' | 'high' | 'all';
}

// –í Prisma schema –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Prisma.JsonObject –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å custom type
```

#### 10. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `console.error` –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

**–§–∞–π–ª—ã:**
- `src/processes/schedulers/subscription.scheduler.ts:80, 130, 276`
- `src/processes/notifications/donki-notifications.ts:47, 53, 95, 133, 165, 197`

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π logger:
```typescript
// src/shared/logger/index.ts
import * as Sentry from '@sentry/node';

export const logger = {
  error: (message: string, error?: unknown, context?: Record<string, any>) => {
    console.error(message, error);
    if (error) {
      Sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
        extra: context,
      });
    }
  },
  info: (message: string, context?: Record<string, any>) => {
    console.log(message, context);
  },
};
```

---

## üîß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 11. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Ç.–¥.

**–§–∞–π–ª—ã:**
- `src/features/subscriptions/commands.subscribe.ts` ‚Äî `handleSubscribeTimeInput`
- `src/processes/bot/handlers/images.ts` ‚Äî –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/shared/lib/validators.ts
export function validateHourUtc(hour: number): boolean {
  return Number.isInteger(hour) && hour >= 0 && hour <= 23;
}

export function validateSearchQuery(query: string): boolean {
  return query.trim().length >= 2 && query.trim().length <= 100;
}
```

#### 12. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ (–∫—Ä–æ–º–µ DONKI notifications).

**–§–∞–π–ª—ã:**
- `src/processes/schedulers/subscription.scheduler.ts:142-160` ‚Äî –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ 403 –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
private async sendApodNotification(subscription: {...}) {
  try {
    // ... –æ—Ç–ø—Ä–∞–≤–∫–∞
  } catch (error: unknown) {
    if (error && typeof error === 'object' && 'response' in error) {
      const telegramError = error as { response?: { error_code?: number } };
      if (telegramError.response?.error_code === 403) {
        // –û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        await this.subscriptionService.disable(subscription.id, subscription.chatId);
        return;
      }
    }
    throw error;
  }
}
```

#### 13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö NotificationLog
**–ü—Ä–æ–±–ª–µ–º–∞:** `NotificationLog` –±—É–¥–µ—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π.

**–§–∞–π–ª—ã:**
- `prisma/schema.prisma:57-73`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å cron job –∏–ª–∏ scheduled task –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:
```typescript
// src/processes/schedulers/cleanup.scheduler.ts
export class CleanupScheduler {
  async cleanupOldLogs() {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    await prisma.notificationLog.deleteMany({
      where: {
        createdAt: {
          lt: thirtyDaysAgo,
        },
      },
    });
  }
}
```

---

## üè≠ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ

#### 14. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç .env.example
**–ü—Ä–æ–±–ª–µ–º–∞:** –í README —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è `.env.example`, –Ω–æ —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `.env.example`:
```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
NASA_API_KEY=your_nasa_api_key
DATABASE_URL=file:./data/bot.db
NODE_ENV=development

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
SENTRY_DSN=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
DOMAIN_URL=http://localhost:3000
WEBHOOK_PORT=3000
```

#### 15. Dockerfile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à—É—é –≤–µ—Ä—Å–∏—é Node.js
**–ü—Ä–æ–±–ª–µ–º–∞:** Dockerfile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `node:14`, –Ω–æ –≤ package.json —Ç—Ä–µ–±—É–µ—Ç—Å—è Node.js 18+.

**–§–∞–π–ª—ã:**
- `Dockerfile:2`

**–†–µ—à–µ–Ω–∏–µ:**
```dockerfile
FROM node:18-alpine
```

#### 16. Makefile —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –æ–±—Ä–∞–∑–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** Makefile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `tg-gpt-chat` –≤–º–µ—Å—Ç–æ `nasa-tg-bot`.

**–§–∞–π–ª—ã:**
- `Makefile:2, 5`

**–†–µ—à–µ–Ω–∏–µ:**
```makefile
build: 
	docker build -t nasa-tg-bot .

run:
	docker run -d -p 3000:3000 --name nasa-tg-bot --rm nasa-tg-bot
```

#### 17. Dockerfile –Ω–µ –∫–æ–ø–∏—Ä—É–µ—Ç Prisma schema –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** Dockerfile –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã —Å—Ä–∞–∑—É, –Ω–æ Prisma –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è schema.

**–§–∞–π–ª—ã:**
- `Dockerfile`

**–†–µ—à–µ–Ω–∏–µ:**
```dockerfile
FROM node:18-alpine
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package files
COPY package*.json ./
COPY prisma ./prisma/

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm ci

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma client
RUN npm run db:generate

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
RUN npm run build

CMD ["npm", "start"]
```

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 18. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç docker-compose.yml
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç docker-compose –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å –ë–î –∏ –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `docker-compose.yml`:
```yaml
version: '3.8'
services:
  bot:
    build: .
    env_file: .env
    volumes:
      - ./data:/app/data
    restart: unless-stopped
```

#### 19. –ù–µ—Ç healthcheck –≤ Dockerfile
**–ü—Ä–æ–±–ª–µ–º–∞:** Dockerfile –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç HEALTHCHECK –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
```

---

## üß™ –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ

#### 20. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–µ—Å—Ç –¥–ª—è `SubscriptionService`, –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –Ω–µ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏.

**–§–∞–π–ª—ã:**
- `tests/subscription.service.spec.ts` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–æ–≤:
```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apod/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apodService.spec.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ apodApi.spec.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscriptions/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ subscription.service.spec.ts ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ nasa.spec.ts
‚îÇ       ‚îî‚îÄ‚îÄ lib/
‚îÇ           ‚îî‚îÄ‚îÄ rateLimiter.spec.ts
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers.spec.ts
‚îÇ   ‚îî‚îÄ‚îÄ subscriptions/
‚îÇ       ‚îî‚îÄ‚îÄ subscription.flow.spec.ts
‚îî‚îÄ‚îÄ e2e/
    ‚îî‚îÄ‚îÄ commands.spec.ts
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. `ApodService` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
2. `NasaApi` ‚Äî retry –º–µ—Ö–∞–Ω–∏–∑–º
3. `RateLimiter` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
4. `SubscriptionScheduler` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã)

---

## üîí –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 21. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Stripe webhook –ø–æ–¥–ø–∏—Å–∏ –≤ development
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `src/app/payments.webhook.ts` –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ development, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ.

**–§–∞–π–ª—ã:**
- `src/app/payments.webhook.ts:16`

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å test webhook secret –≤ development:
```typescript
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
if (!webhookSecret) {
  throw new Error('STRIPE_WEBHOOK_SECRET is required');
}
// –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å
```

#### 22. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `src/app/payments.webhook.ts:95` —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π Stripe –∫–ª–∏–µ–Ω—Ç, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —É—Ç–µ—á–∫—É —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö:
```typescript
function maskToken(token: string): string {
  if (token.length < 8) return '***';
  return token.slice(0, 4) + '***' + token.slice(-4);
}

console.log('Stripe key:', maskToken(process.env.STRIPE_SECRET_KEY || ''));
```

#### 23. –ù–µ—Ç rate limiting –¥–ª—è webhook endpoint
**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook endpoint –Ω–µ –∑–∞—â–∏—â–µ–Ω –æ—Ç DDoS –∞—Ç–∞–∫.

**–§–∞–π–ª—ã:**
- `src/app/webhook.server.ts`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å rate limiting:
```typescript
import rateLimit from 'express-rate-limit';

const webhookLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 100, // –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤
});

app.use('/api/payments', webhookLimiter, createStripeWebhookHandler());
```

#### 24. SQL injection —á–µ—Ä–µ–∑ Prisma (–Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫)
**–ü—Ä–æ–±–ª–µ–º–∞:** Prisma –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL injection, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Prisma –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `$queryRaw`.

---

## ‚ö° –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 25. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è NASA API –æ—Ç–≤–µ—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ NASA API –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ, –Ω–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.

**–§–∞–π–ª—ã:**
- `src/shared/api/nasa.ts`
- `src/features/apod/services/apodService.ts`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis –∏–ª–∏ in-memory):
```typescript
// src/shared/lib/cache.ts
import NodeCache from 'node-cache';

const cache = new NodeCache({ stdTTL: 3600 }); // 1 —á–∞—Å

export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 3600
): Promise<T> {
  const cached = cache.get<T>(key);
  if (cached) return cached;
  
  const data = await fetcher();
  cache.set(key, data, ttl);
  return data;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const apod = await getCached(
  `apod:${date}`,
  () => this.apodApi.getApod(date),
  3600
);
```

#### 26. Rate limiter —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** `rateLimiter.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Map` –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.

**–§–∞–π–ª—ã:**
- `src/shared/lib/rateLimiter.ts:12`

**–†–µ—à–µ–Ω–∏–µ:** –î–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis:
```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –¥–ª—è rate limiting
```

#### 27. –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤ –∑–∞ 7 –¥–Ω–µ–π) –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É.

**–§–∞–π–ª—ã:**
- `src/features/asteroids/services/asteroidsService.ts`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∏–ª–∏ –ª–∏–º–∏—Ç—ã:
```typescript
async getAsteroids(days: number, limit: number = 50) {
  // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
}
```

#### 28. SubscriptionScheduler –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø–∞–º—è—Ç—å
**–ü—Ä–æ–±–ª–µ–º–∞:** `listAllEnabled()` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å—Ä–∞–∑—É.

**–§–∞–π–ª—ã:**
- `src/processes/schedulers/subscription.scheduler.ts:64`

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –∏–ª–∏ –±–∞—Ç—á–∏–Ω–≥:
```typescript
async processSubscriptions() {
  const currentHourUtc = new Date().getUTCHours();
  
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å findMany —Å where –∏ take –¥–ª—è –±–∞—Ç—á–∏–Ω–≥–∞
  let skip = 0;
  const batchSize = 100;
  
  while (true) {
    const subscriptions = await this.subscriptionService.listEnabledForHour(
      currentHourUtc,
      { skip, take: batchSize }
    );
    
    if (subscriptions.length === 0) break;
    
    for (const sub of subscriptions) {
      await this.sendSubscriptionNotification(sub);
    }
    
    skip += batchSize;
  }
}
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 29. README –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É
**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –í README —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è `.env.example`, –Ω–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
- –ù–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –¥–µ–ø–ª–æ—é

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å README —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

#### 30. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö API (—Å–µ—Ä–≤–∏—Å–æ–≤, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å `docs/API.md`.

---

## üó∫Ô∏è Roadmap —É–ª—É—á—à–µ–Ω–∏–π

### üü¢ –°—Ä–æ—á–Ω–æ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è production)

1. **–°–æ–∑–¥–∞—Ç—å `.env.example`** ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å Dockerfile** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å Node.js –≤–µ—Ä—Å–∏—é –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É Prisma
3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å Makefile** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –æ–±—Ä–∞–∑–∞
4. **–£–±—Ä–∞—Ç—å `any` —Ç–∏–ø—ã** ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è params –ø–æ–¥–ø–∏—Å–æ–∫
5. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ action handlers** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–º–∏—Å—ã
6. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é env —á–µ—Ä–µ–∑ zod** ‚Äî —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–û—Ü–µ–Ω–∫–∞:** 4-6 —á–∞—Å–æ–≤

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞)

7. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ FSD** ‚Äî —É–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ features –æ—Ç processes
8. **–†–∞—Å—à–∏—Ä–∏—Ç—å DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
9. **–°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** ‚Äî –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –ë–î
10. **–î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –¥–ª—è NASA API –æ—Ç–≤–µ—Ç–æ–≤
11. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –µ–¥–∏–Ω—ã–π logger —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
12. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã** ‚Äî –ø–æ–∫—Ä—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥—É–ª–∏ (ApodService, NasaApi, RateLimiter)
13. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤–≤–æ–¥–∞** ‚Äî –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
14. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–æ—Ç–∞** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
15. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤** ‚Äî scheduled task –¥–ª—è NotificationLog

**–û—Ü–µ–Ω–∫–∞:** 2-3 –¥–Ω—è

### ‚ö™ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (nice to have)

16. **–î–æ–±–∞–≤–∏—Ç—å docker-compose.yml** ‚Äî –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
17. **–î–æ–±–∞–≤–∏—Ç—å healthcheck** ‚Äî –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
18. **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Redis** ‚Äî –¥–ª—è rate limiting –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
19. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é** ‚Äî –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
20. **–£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** ‚Äî API docs, deployment guide
21. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
22. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î** ‚Äî –∏–Ω–¥–µ–∫—Å—ã, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û—Ü–µ–Ω–∫–∞:** 1-2 –Ω–µ–¥–µ–ª–∏

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –î–ª—è FSD —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. –°–æ–∑–¥–∞—Ç—å `shared/types/telegram.ts` —Å –±–∞–∑–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏
2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑ `features/subscriptions/` –≤ `processes/bot/handlers/subscriptions/`
3. –û—Å—Ç–∞–≤–∏—Ç—å –≤ `features/subscriptions/` —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (—Å–µ—Ä–≤–∏—Å—ã)

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ù–∞—á–∞—Ç—å —Å unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ (ApodService, AsteroidsService)
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (NASA, Telegram)

### –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. –ù–∞—á–∞—Ç—å —Å in-memory –∫–µ—à–∞ (node-cache) –¥–ª—è NASA API
2. –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Redis
3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** ~5% (—Ç–æ–ª—å–∫–æ SubscriptionService)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any`:** 17 –º–µ—Å—Ç
- **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 0 (—Ö–æ—Ä–æ—à–æ!)
- **–ù–∞—Ä—É—à–µ–Ω–∏—è FSD:** 2 (features ‚Üí processes)
- **–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 3 (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç **—Ö–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –æ—Å–Ω–æ–≤—É** –∏ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º FSD. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:
- –ù–µ–ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π DI
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Ç–µ—Å—Ç–æ–≤
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- –ü—Ä–æ–±–ª–µ–º–∞–º–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Docker, env)

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (üü¢ –°—Ä–æ—á–Ω–æ) –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ production. –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π –ø–æ–≤—ã—Å–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞.

---

**–ê–≤—Ç–æ—Ä –∞—É–¥–∏—Ç–∞:** AI Code Reviewer  
**–î–∞—Ç–∞:** 2025-01-XX

